## 4 캐시
코어와 메인 메모리 사이에 위치한 작고 빠른 메모리. 멀리 존재하는(따라서 접근 속도가 느린) 메인 메모리의 사본을 일부 유지한다.
코어가 특정 주소에 접근 -> 먼저 캐시에 존재하는 주소와 비교 -> 일치하는 인스트럭션 또는 데이터가 있다면 메모리에서 찾지 않고 캐시에서 읽거나 쓴다. -> 캐시를 적절히 활용하면 시스템 성능 향상을 가져옴
1) 폰 노이만 아키텍처 : 인스트럭션과 데이터의 버스 및 캐시가 통합
2) 하버드 아키텍처 : 인스트럭션과 데이터의 버스 및 캐시가 분리 되있음. I-cache와 D-cache. ARM은 하버드 아키텍처를 따름

ARMv8-A 아키텍처 프로세서들은 보통 2개 이상의 캐시 레벨로 구성됨. 
1) L1캐시 : 각 코어마다 존재하며 I-cache와 D-cache로 분리됨
2) L2캐시 : 클러스터마다 코어들이 공유하는 통합 캐시로 두는게 일반적.
3) L3캐시 : 클러스터 사이에 공유하며 optional.

### 4.1 캐시 구조
 * 태그 : 캐시 탐색 시 저장되는 메모리 주소의 일부. 캐시 라인과 연결된 메모리 주소를 식별하는 데 사용.

### 4.2 캐시 컨트롤러
 - 캐시를 관리하는 하드웨어로, 메인 메모리와 캐시 사이의 코드와 데이터 읽기/쓰기를 담당.
 - 캐시 탐색(cache loopup) : 코어가 요청한 읽기/쓰기 대상 주소를 캐시에서 찾는다.
	* 해당 인덱스의 캐시 라인중에 태그가 일치하는 캐시 라인이 있고(hit)유효 비트가 설정되어 있다면(valid), 해당 캐시 메모리로 읽기/쓰기 동작 수행.
	* 코어가 요청한 주소가 캐시 태그와 일치하지 않거나 태그가 유효하지 않다면 캐시 미스(cache miss) 발생 -> 메모리 계층의 다음 레벨(다음 레벨의 캐시 or 외부 메모리)로 요청을 전달해서 탐색을 계속함. -> 찾음ㄴ 해당 내용을 캐시로 복사하며(cache linefill) 동시에 요청된 데이터/인스트럭션은 코어로 보내짐. 
 
### 4.3 캐시 정책
 - 캐시 할당 정책에는 쓰기(write allocation, WA)와 읽기 할당(Read allocation, RW)이 있다. eg) 쓰기 할당은 쓰기 miss 시에 캐시 라인을 할당 한다.
 - 캐시 갱신 정책
  1) write-back 정책 : 쓰기 요청이 오면 캐시 라인까지만 갱신하고 dirty bit(캐시라인이 메인 메모리의 내용과 일치하지 않는 상태를 나타냄)를 설정.
   * 외부 메모리는 캐시 라인의 방출이나 명시적인 클린에 의해 갱신됨.
  2) write-through 정책 : 쓰기 시, 외부 메모리와 캐시를 함께 갱신. 캐시 라인과 메모리의 내용이 일치하므로 dirty bit는 설정되지 않음.
 
### 4.4 캐시 일관성의 두 가지 관점
 - 캐시 조작 인스트럭션
  1) set/way를 지정하는 방식 : clean, invalidate 인스트럭션은 캐시의 레벨을 지정하는 방식으로 동작
  2) 가상 주소를 지정하는 방식
   2-1) PoC(Point of Coherency) : 특정 주소에 대해 다른 코어, DSP, DMA처럼 메모리에 접근할 수 있는 모든 옵저버가 동일한 메모리 사본을 볼 수 있도록 보장함. 
   2-2) PoU(Point of Unification) : 한 코어 안의 I-cache와 D-cache, TLB 등이 동일한 메모리 사본을 볼 수 있도록 보장함. I,D 캐시가 분리되어 있는 하버드 캐시 타입에서 두 캐시 간의 일관성을 위해 PoU 캐시 조작 인스트럭션을 사용한다.

### 4.5 캐시 관리
 - 소프트웨어가 캐시를 clean하거나 invalidate(무효화) 해야 할 떄가 있다. 둘 다 write-back 정책으르 쓰는 데이터 캐시에만 적용 가능.
  eg) 외부 메모리의 내용이 변경되고 캐시에서 오래된 데이터를 제거해야 하는 경우, MMU작업 후 등.
 - 캐시, 캐시라인의 무효화 = 캐시 라인의 유효 비트를 클리어 해서 데이터를 클리어 하는 것. 무효화가 반드시 필요한 경우 : 리셋 후, 모든 캐시된 데이터를 보장 할 수 없으므로.
 - 캐시, 캐시라인의 클린 = dirty로 설정된 캐시 라인을 다음 레벨의 캐시 또는 메인 메모리로 쓰고, 캐시 라인의 dirty bit를 clear.

### 4.6 캐시 탐색
 - 제공되는 캐시 관련 레지스터들을 통해 캐시 및 캐시라인의 크기, 세트/웨이의 수, 캐시 레벨 수 등을 확인 가능.

### MEMO
