## 3 AArch64 익셉션 핸들링
일반적으로 SW의 실행 흐름을 가로채는 동작을 인터럽트라고 하지만, ARM은 익셉션이라는 용어를 사용. ARM에서 인터럽트는 익셉션의 하나이다.
익셉션 발생 -> 이전 실행 흐름에서 벗어나 익셉션 타입에 따른 익셉션 핸들러 호출 -> 핸들러는 익셉션을 처리 -> 익셉션 발생 전의 상태에서 실행을 재개함.

### 3.1 익셉션 타입
* 익셉션을 발생시키는 상태 및 시스템 이벤트
 1) 서비스 호출 인스트럭션 익셉션
	- SW에서 좀 더 높은 privileged level에서 동작하는 서비스를 요청하기 위해 호출함.
	- SVC(Supervisor Call) : 유저 모드 프로그램에서 OS 서비스를 요청할 때 씀
	- HVC(Hypervisor Call) : 게스트 OS에서 하이퍼바이저 서비스를 요청할 때 씀
	- SMC(Secure Monitor Call) : normal world에서 secure world 서비스를 요청할 때 씀
 2) ABORT 익셉션
	- 인스트럭션 abort : 인스트럭션 fetch가 실패할 경우
	- 데이터 abort : 데이터 접근이 실패 할 경우, 데이터 load/store 인스트럭션 실행결과 발생
 3) 리셋 익셉션
	- 전원을 켠 후 코어를 초기화하는 코드를 실행하는데 쓰임
	- 코어에 리셋 입력 -> 리셋 익셉션 발생 -> 코어는 리셋 벡터로 점프 -> 실행할 인스트럭션의 주소가 저장되있음
 4) 인터럽트 익셉션
	- ARM아키텍처의 인터럽트는 IRQ,FIQ로 나뉘며 FIQ가 IRQ보다 우선순위가 더 높다. 최근엔 FIQ가 주로 보안 인터럽트를 담당.
	- 인터럽트는 인터럽트 컨트롤러와 코어를 연결한 IRQ, FIQ 라인을 통해 물리적 신호로 전달됨.
	- 인터럽트 컨트롤러는 연결된 각 디바이스의 인터럽트 신호를 중재하고 우선순위를 지정하며 최종적으로 각 코어의 IRQ또는 FIQ로 전달함

### 3.2 동기 및 비동기 익셉션
 1) 동기 익셉션 : 인스트럭션 실행 또는 실행 시도의 결과로 발생, 리턴 주소는 익셉션을 발생시킨 인스트럭션
				eg) MMU의 인스트럭션, 데이터 Abort, PC/SP의 정력 위반, 동기 외부 abort, 할당되지 않은/허용되지 않은 인스트럭션 실행
 2) 비동기 익셉션 : 인스트럭션의 실행과 무관, 리턴 주소가 익셉션 원인에 대한 정보를 제공하지 않을 수 있음
				eg) IRQ,FIQ,SError

### 3.3 익셉션 핸들링
 1) 익셉션 발생
 2) SPSR_ELn은 익셉션이 끝날 때 올바르게 리턴하는 데 필요한 PSTATE 정보를 저장하기 위해 갱신됨.
 3) PSTATE가 새 프로세서 상태를 반영하도록 갱신됨. (익셉션 레벨은 상승하거나 동일)
 4) 익셉션 처리가 끝나고 돌아갈 복귀 주소는 ELR_ELn에 저장됨.
 5) PC가 해당 벡터 테이블 엔트리로 설정됨. 이때 Synchronous타입과 SError인 경우에 ESR_ELn에 익셉션 발생원인이 기록됨.
 6) 익셉션 처리 끝난 후 ERET 인스트럭션을 실행하면 프로세서는 익셉션 이전 상태를 저장해뒀던 SPSR_ELn를 PSTATE로 복원.
 7) ELR_ELn에서 PC를 복원하여 익셉션 이전 실행 위치로 복귀.

### 3.4 익셉션에 의해 변경되는 실행 상태와 익셉션 레벨
익셉션 발생과 복귀 시점에 실행 상태(AArch32 AArch64)나 익셉션 레벨이 변경될 수 있다.
eg)64비트 커널 + 32비트 애플리케이션 실행 상황
 애플리케이션 실행중에 SVC 인스트럭션을 사용하거나 익셉션이 발생하면,
 익셉션 레벨은 EL0 -> EL1
 실행 상태는 AArch32 -> AArch64 로 변경됨.
 익셉션 처리가 끝나면 ERET 인스트럭션을 사용해 다시 복귀함.

* AArch32 레지스터
 - AArch64 레지스터의 하위 32비트에 위치함. AArch32에서 AArch64레지스터의 상위 32비트는 접근할 수 없고 무시된다.
 - AArch64에서 AArch32의 상위 32비트는 0 또는 AArch64에 쓰여진 마지막 값을 갖음.
 - 익셉션이 발생해 AArch64로 변경되면 AArch32 레지스터의 내용이 AArch64에 존재함.

### 3.5 AArch64 익셉션 벡터 테이블
익셉션 발생 -> 프로세서는 익셉션에 대응하는 약속된 위치의 핸들러 코드를 수행.
* 익셉션 벡터 : 핸들러가 저장된 메모리 영역. 테이블로 구성. EL0을 제외한 각 EL은 각각 벡터 테이블을 가짐.

### 3.6 인터럽트 핸들링
하드웨어적인 입력 신호를 받는 IRQ와 FIQ 핀으로 인터럽트 시그널을 받음.


### 3.7 GIC, 표준 인터럽트 컨트롤러
* Generic Interrupt Controller)
 - GIC는 인터럽트 소스를 관리하며, 인터럽트가 발생하면 연결된 각 코어에 인터럽트를 전달(라우팅)하고 우선순위를 정함.
 - SPI(shared Peripheral interrupt)지원, 멀티코어 시스템을 위해 여러 코어를 대상으로 전달되는 인터럽트
 - PPI(Private Peripheral interrupt)지원, 특정 코어에게 전달되는 인터럽트

### MEMO
